# This file was generated by AI and is not subject to copyright protection.
# It is dedicated to the public domain.

# CMakeLists.txt for the Ananbox standalone server (for Termux)
# This builds the server and proot for running in Termux on Android devices

option(BUILD_ANANBOX_SERVER "Build the standalone Ananbox server for Termux" OFF)

if(BUILD_ANANBOX_SERVER)
    if(NOT ANDROID)
        message(FATAL_ERROR "The standalone server is designed for Termux (Android). Please use the Android NDK toolchain.")
    endif()
    
    # Build proot for Termux
    # Path: from anbox/src/server/ go up 3 levels to app/src/main/cpp/, then into cmake/
    include(${CMAKE_CURRENT_SOURCE_DIR}/../../../cmake/ProotTermux.cmake)

    set(SERVER_SOURCES
        server/streaming_protocol.h
        server/streaming_server.h
        server/streaming_server.cpp
        server/main.cpp
    )

    add_executable(ananbox-server ${SERVER_SOURCES})
    
    target_include_directories(ananbox-server PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}/anbox
        ${Boost_INCLUDE_DIRS}
    )
    
    target_link_libraries(ananbox-server
        anbox-core
        ${Boost_LIBRARIES}
        pthread
        log
        android
        EGL
        GLESv2
    )
    
    # Add dependency on proot for Termux builds
    if(TARGET ${PROOT_TARGET})
        add_dependencies(ananbox-server ${PROOT_TARGET})
    endif()

    # Install the server binary
    install(TARGETS ananbox-server DESTINATION bin)
    
    # Install proot alongside the server
    if(EXISTS ${PROOT_BINARY})
        install(PROGRAMS ${PROOT_BINARY} DESTINATION bin)
    endif()
endif()
